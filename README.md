# NeosuranceSDK_v3_swift
Neosurance iOS SDK Vers. 3 (swift)

# ![](https://upload.wikimedia.org/wikipedia/commons/thumb/c/ca/IOS_logo.svg/32px-IOS_logo.svg.png) iOS - NeosuranceSDK_v3_swift

- Collects info from device sensors and from the hosting app
- Exchanges info with the AI engines
- Sends the push notification
- Displays a landing page
- Displays the list of the purchased policies

## Installation

### iOS

1. NeosuranceSDK_v3_swift is available through [CocoaPods](https://cocoapods.org/pods/NSR_SDK_v3_swift). To install it, simply add the following line to your Podfile:

```ruby
target 'NSR SDK SwiftExample' do  
  use_frameworks!

  pod 'NSR_SDK_v3_swift'
end
```

2. Run in the same directory of your Podfile:

```ruby
pod install
```

## Requirements

1. Inside your **info.plist** be sure to have the following permissions:

```xml
<key>NSCameraUsageDescription</key>
<string>use camera...</string>
<key>NSLocationAlwaysAndWhenInUseUsageDescription</key>
<string>Always and when in use...</string>
<key>NSLocationAlwaysUsageDescription</key>
<string>Always...</string>
<key>NSLocationWhenInUseUsageDescription</key>
<string>When in use...</string>
<key>NSMotionUsageDescription</key>
<string>Motion...</string>
```

## Settings

1. ### setup
	Earlier in your application startup flow (tipically inside the **application didFinishLaunchingWithOptions** method of your application) call the **setup** method using

	**base_url**: provided by us, used only if no *securityDelegate* is configured  
	**code**: the community code provided by us  
	**secret_key**: the community secret key provided by us  
	**dev_mode** *optional*: [0|1] activate the *developer mode*  
		
	```swift	
	let nsr = NSR.getSharedInstance()
    
	nsr.workflowDelegate = WFDelegate()
	
	let settings = NSMutableDictionary()
	settings.setValue(self.config["base_url"], forKey: "base_url")
	settings.setValue(self.config["code"], forKey: "code")
	settings.setValue(self.config["secret_key"], forKey: "secret_key")
	settings.setValue(true, forKey: "dev_mode")
	
	nsr.setup(settings: settings)	
	```
	
2. ### forwardNotification
	In Order to manage the pushes generated by the *SDK* add the ***forwardNotification*** method in your app notification handler 

	```swift
	func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -> Void) {
        
		if let code = response.notification.request.content.userInfo["code"] as? String {
			print(">>> code: " + code)
		}
        
		if let expirationTime = response.notification.request.content.userInfo["expirationTime"] as? String {
			print(">>> expirationTime: " + expirationTime)
		}
        
		if(NSR.getSharedInstance().forwardNotification(response: response)){
			//TODO: handle notification...
		}
        
		completionHandler()
        
	}
	```
	and remember to implement also 
	
	```swift
	func userNotificationCenter(_ center: UNUserNotificationCenter, willPresent notification: UNNotification, withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {
	        completionHandler(UNNotificationPresentationOptions.init(arrayLiteral: [.alert, .sound])) //.badge
	}
	```
	
3. ### securityDelegate *optional*
	If the communications must be secured using any policy.  
	A **securityDelegate** implementing the following protocol can be configured:
	
	```swift
	public protocol NSRSecurityDelegate: NSObject{
	    func secureRequest( endpoint: String, payload: NSDictionary, headers: NSDictionary, completionHandler: @escaping(_ responseObject: NSDictionary, _ error: NSError?)->() )
	}	
	```
	
	```swift
	public func secureRequest(endpoint: String, payload: NSDictionary, headers: NSDictionary, completionHandler: @escaping (NSDictionary, NSError?) -> ()) {...}
	```
	
4. ### setWorkFlowDelegate *optional*  
	If the purchase workflow must be interrupted in order to perform user login or to perform payment.  
	A **workflowDelegate** implementing the following interface must be configured:
	
	```swift
	public protocol NSRWorkflowDelegate: NSObject{
	    func executeLogin(url: String)->(Bool)
	    func executePayment(payment: NSDictionary, url: String)->(NSDictionary)
	    func confirmTransaction(paymentInfo: NSDictionary)->()
	    func keepAlive()->()
	}
	```

	```swift
	let nsr = NSR.getSharedInstance()
	nsr.workflowDelegate = WFDelegate()	
	```
	
	when login or payment is performed you must call the methods **loginExecuted** and **paymentExecuted** to resume the workflow
	
	```swift
	NSR.getSharedInstance().loginExecuted(url: url)
	...
	NSR.getSharedInstance().paymentExecuted(paymentInfo: paymentInfo, url: url)
	```
	
5. ### Register User  
	When the user is recognized by your application, register him in our *SDK* creating an **NSRUser** and using the **registerUser** method.  
	The **NSRUser** has the following fields:
	
	**code**: the user code in your system (can be equals to the email)  
	**email**: the email is the real primary key  
	**firstname** *optional*  
	**lastname** *optional*  
	**mobile** *optional*  
	**fiscalCode** *optional*  
	**gender** *optional*  
	**birthday** *optional*  
	**address** *optional*  
	**zipCode** *optional*  
	**city** *optional*  
	**stateProvince** *optional*  
	**country** *optional*  
	**extra** *optional*: will be shared with us  
	**locals** *optional*: will not be exposed outside the device  
	
	

	```swift
	let user = NSRUser()        
	
	user.code = (self.config["user.code"] as! String)
	user.email = (self.config["user.email"] as! String)
	user.firstname = (self.config["user.firstname"] as! String)
	user.lastname = (self.config["user.lastname"] as! String)
	user.country = (self.config["user.country"] as! String)
	user.fiscalCode = (self.config["user.fiscalCode"] as! String)
	user.address = (self.config["user.address"] as! String)
	user.city = (self.config["user.city"] as! String)
	user.stateProvince = (self.config["user.stateProvince"] as! String)
	
	let locals = NSMutableDictionary()
	
	locals.setObject(user.email ?? "", forKey:"email" as NSCopying)
	locals.setObject(user.firstname ?? "", forKey:"firstname" as NSCopying)
	locals.setObject(user.lastname ?? "", forKey:"lastname" as NSCopying)
	locals.setObject(user.fiscalCode ?? "", forKey:"fiscalCode" as NSCopying)
	locals.setObject(user.address ?? "", forKey:"address" as NSCopying)
	locals.setObject(user.city ?? "", forKey:"city" as NSCopying)
	locals.setObject(user.stateProvince ?? "", forKey:"stateProvince" as NSCopying)
	locals.setObject("fake-push", forKey:"pushToken" as NSCopying)            
	
	user.locals = locals
	
    let nsr = NSR.getSharedInstance()
    nsr.registerUser(user: user)	
	```


7. ### Show App
	Is possible to show the list of the purchased policies (*communityApp*) using the **showApp** methods
	
	```swift
	NSR.getSharedInstance().showApp()
	```
	or
	
	```swift
	let params = NSMutableDictionary()
	params.setObject(profiles, forKey: "page" as NSCopying)
	NSR.getSharedInstance().showApp(params: params)	
	```
8. ### showUrl *optional*
	If custom web views are needed the **showUrl** methods can be used
	
	```swift
	NSR.getSharedInstance().showUrl(url: url)
	```
	or
	
	```swift
	let params = NSMutableDictionary()
	params.setObject("true", forKey: "profile" as NSCopying)
	NSR.getSharedInstance().showUrl(url: url, params: params?)	
	```
9. ### Send Event
	The application can send explicit events to the system with **sendEvent** method
	
	```swift
	let params = NSMutableDictionary()
	params.setObject("latitude", forKey: "latitude" as NSCopying)
	params.setObject("longitude", forKey: "longitude" as NSCopying)
	NSR.getSharedInstance().sendEvent(event:"position", payload:payload)
	```
	
10. ### sendAction *optional*
	The application can send tracing information events to the system with **sendAction** method
	
	```swift          
	let nsr = NSR.getSharedInstance()
	nsr.sendAction(action: "read" as! String, code: "xxxx123xxxx" as! String, details: "general condition read" as! String)
	```
	
## Usage (Sample Demo Flow)
1. Tap on button => *"Setup"* (see 1. [setup](#setup))
2. Tap on button => *"registerUser"* (see 5. [registerUser](#register-user))
3. [4.] Tap on button => *"sendEvent: ondemand"* (and/or *"sendEventPush: testpush"*) (see 9. [sendEvent](#send-event))
4. [3.] Tap on button => *"showApp"* In order to show "Purchases List" or "buy a new insurance policy"(just tapping on the title)) (see 7. [showApp](#show-app))	
	
## Author

info@neosurance.eu

## License

NeosuranceSDK is available under the MIT license. See the LICENSE file for more info.

